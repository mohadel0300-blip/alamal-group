<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>الأمل جروب | النظام السحابي</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      theme: {
        extend: {
          fontFamily: { cairo: ["Cairo", "system-ui", "-apple-system", "sans-serif"] },
          boxShadow: { soft: "0 10px 30px rgba(2,6,23,0.06)" },
          animation: { pulse: "pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite" }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --brand: #0f766e;
      --brand2:#14532d;
      --accent:#f59e0b;
      --danger:#ef4444;
      --ink:   #0f172a;
      --bg:    #f8fafc;
    }
    html, body {
      font-family: Cairo, system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--ink);
      -webkit-tap-highlight-color: transparent;
    }
    * { box-sizing: border-box; }
    button { touch-action: manipulation; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    .app-bg{
      background: radial-gradient(1200px 600px at 10% 0%, rgba(15,118,110,.08), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(245,158,11,.10), transparent 55%),
                  linear-gradient(#f8fafc, #f8fafc);
      background-attachment: fixed;
    }

    .table-wrap::-webkit-scrollbar{ height: 8px; width: 8px; }
    .table-wrap::-webkit-scrollbar-thumb{ background: #cbd5e1; border-radius: 999px; }
    .table-wrap::-webkit-scrollbar-track{ background: #f1f5f9; border-radius: 999px; }

    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    .mobile-main-pad { padding-bottom: calc(82px + env(safe-area-inset-bottom)); }

    .animate-in { animation-fill-mode: both; }
    .fade-in { animation-name: fadeInUp; animation-duration: 200ms;}
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body class="app-bg">
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    /***********************
     * Firebase Initialization
     ***********************/
    const firebaseConfig = {
      databaseURL: "https://alamalgroup-429e0-default-rtdb.firebaseio.com/",
      projectId: "alamalgroup-429e0",
    };
    
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    /***********************
     * Firebase Sync Hook
     ***********************/
    function useFirebaseState(key, initialValue) {
      const [state, setState] = useState(initialValue);
      const [isLoaded, setIsLoaded] = useState(false);

      useEffect(() => {
        const ref = db.ref(key);
        const listener = ref.on('value', (snapshot) => {
          if (snapshot.exists()) {
            setState(snapshot.val());
          } else {
            setState(initialValue);
          }
          setIsLoaded(true);
        });
        return () => ref.off('value', listener);
      }, [key]);

      const updateState = (updater) => {
        setState((prev) => {
          const newVal = typeof updater === 'function' ? updater(prev) : updater;
          db.ref(key).set(newVal);
          return newVal;
        });
      };

      return [state, updateState, isLoaded];
    }

    /***********************
     * Local Storage Hook (For Session)
     ***********************/
    function useLocalStorageState(key, initialValue){
      const [state, setState] = useState(() => {
        try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initialValue; }
        catch { return initialValue; }
      });
      useEffect(() => { try { localStorage.setItem(key, JSON.stringify(state)); } catch {} }, [key, state]);
      return [state, setState];
    }

    /***********************
     * Icons
     ***********************/
    const ICONS = {
      menu: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>),
      x: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg>),
      logout: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg>),
      home: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>),
      dashboard: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="8" height="8" rx="2"/><rect x="13" y="3" width="8" height="5" rx="2"/><rect x="13" y="10" width="8" height="11" rx="2"/><rect x="3" y="13" width="8" height="8" rx="2"/></svg>),
      cart: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="9" cy="20" r="1"/><circle cx="17" cy="20" r="1"/><path d="M3 4h2l2.2 10.5a2 2 0 0 0 2 1.5h7.6a2 2 0 0 0 2-1.6L21 7H6"/></svg>),
      truck: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 7h11v10H3z"/><path d="M14 10h4l3 3v4h-7z"/><circle cx="7" cy="19" r="1.5"/><circle cx="18" cy="19" r="1.5"/></svg>),
      users: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>),
      user: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>),
      userPlus: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>),
      briefcase: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>),
      coins: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="8" cy="8" r="7"></circle><line x1="8" y1="12" x2="8" y2="12"></line><line x1="8" y1="4" x2="8" y2="4"></line><line x1="4" y1="8" x2="4" y2="8"></line><line x1="12" y1="8" x2="12" y2="8"></line><path d="M16 16v.01"></path><path d="M16 12v.01"></path><path d="M12 16v.01"></path><path d="M20 16v.01"></path><path d="M16 20v.01"></path></svg>),
      receipt: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 2h12v20l-2-1-2 1-2-1-2 1-2-1-2 1z"/><path d="M9 6h6"/><path d="M9 10h6"/><path d="M9 14h6"/></svg>),
      plus: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>),
      package: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 8l-9 5-9-5"/><path d="M3 8V16l9 5 9-5V8"/><path d="M12 13v8"/></svg>),
      wallet: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 7h18v14H3z"/><path d="M3 7a2 2 0 0 1 2-2h14v2H5a2 2 0 0 0-2 2z"/><path d="M17 13h4"/><circle cx="17" cy="13" r="0.5" fill="currentColor"/></svg>),
      trash: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M19 6l-1 16H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>),
      printer: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9V4h12v5"/><path d="M6 18h12v2H6z"/><path d="M6 14h12v4H6z"/><path d="M6 13H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2"/></svg>),
      lock: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>),
      settings: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/><circle cx="12" cy="12" r="3"/></svg>),
      car: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 16l1-5a3 3 0 0 1 3-2h10a3 3 0 0 1 3 2l1 5"/><path d="M5 16h14"/><circle cx="7" cy="17.5" r="1.5"/><circle cx="17" cy="17.5" r="1.5"/><path d="M6 9l2-3h8l2 3"/></svg>),
      brand: (p) => (
        <svg {...p} viewBox="0 0 64 64" fill="none">
          <defs>
            <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stopColor="var(--brand)"/><stop offset="1" stopColor="var(--brand2)"/>
            </linearGradient>
          </defs>
          <path d="M34 6c10 0 18 10 18 24S44 58 34 58 16 44 16 30 24 6 34 6Z" fill="url(#g1)" opacity=".16"/>
          <path d="M32 10c9 0 16 9 16 21S41 54 32 54 16 44 16 31 23 10 32 10Z" fill="url(#g1)"/>
          <path d="M40 18c7 2 10 8 10 13-6-2-12-5-16-10 2-2 4-3 6-3Z" fill="var(--accent)" opacity=".9"/>
          <circle cx="27" cy="30" r="2.2" fill="#0b1220" opacity=".85"/>
          <path d="M25 38c2 3 5 5 8 5 4 0 7-2 10-6" stroke="#0b1220" strokeWidth="3" strokeLinecap="round" opacity=".35"/>
        </svg>
      ),
      cloudSync: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/><polyline points="8 15 12 11 16 15"/><line x1="12" y1="11" x2="12" y2="21"/></svg>)
    };

    function Icon({ name, size = 20, className = "" }) {
      const Comp = ICONS[name];
      return Comp ? <Comp width={size} height={size} className={className} /> : null;
    }

    /***********************
     * Helpers
     ***********************/
    function toNumber(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
    function formatMoney(n){ return toNumber(n).toLocaleString("ar-EG"); }
    function formatQty(n){ return toNumber(n).toLocaleString("ar-EG"); }
    function computeDebt(total, paid){ return Math.max(toNumber(total) - toNumber(paid), 0); }
    function getToday(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

    /***********************
     * Auth & Roles
     ***********************/
    const DEFAULT_ADMIN = [{ id: 1, username: "admin", displayName: "المدير (المالك)", pin: "0000", role: "admin" }];

    const ROLE_TABS = {
      admin: ["dashboard","treasury","settlements","sales","purchases","expenses","receipts","products","customers","suppliers","drivers","users_manage","settings"],
      clerk: ["sales","purchases","expenses","receipts","settings"],
    };
    function canSeeTab(role, tabId){ return (ROLE_TABS[role] || []).includes(tabId); }

    /***********************
     * UI Components
     ***********************/
    const Card = ({ children, className = "" }) => (
      <div className={`bg-white p-4 sm:p-6 rounded-2xl shadow-soft border border-slate-100 ${className}`}>{children}</div>
    );

    const Notice = ({ variant="info", children }) => {
      const styles = variant === "info" ? "bg-emerald-50 border-emerald-200 text-emerald-900" :
                     variant === "warn" ? "bg-amber-50 border-amber-200 text-amber-900" :
                     "bg-red-50 border-red-200 text-red-900";
      return <div className={`border p-4 rounded-2xl ${styles}`}>{children}</div>;
    };

    const Field = ({ label, hint, children, className="" }) => (
      <div className={`flex flex-col gap-1 ${className}`}>
        <label className="text-xs text-slate-500 font-black">{label}</label>
        {children}
        {hint && <div className="text-[11px] text-slate-400 font-bold">{hint}</div>}
      </div>
    );

    const Input = (props) => (
      <input {...props} className={`border border-slate-200 bg-white p-3 rounded-xl outline-none focus:ring-2 focus:ring-teal-700/20 focus:border-teal-700/50 transition w-full text-slate-900 ${props.className||""}`} />
    );

    const Select = (props) => (
      <select {...props} className={`border border-slate-200 bg-white p-3 rounded-xl outline-none focus:ring-2 focus:ring-teal-700/20 focus:border-teal-700/50 transition w-full text-slate-900 ${props.className||""}`} />
    );

    const Button = ({ variant="primary", className="", children, ...props }) => {
      const base = "px-4 py-3 rounded-xl font-black transition inline-flex items-center justify-center gap-2 w-full sm:w-auto active:scale-[.99]";
      const styles =
        variant === "primary" ? "bg-[color:var(--brand)] text-white hover:brightness-110" :
        variant === "success" ? "bg-emerald-600 text-white hover:bg-emerald-700" :
        variant === "danger" ? "bg-[color:var(--danger)] text-white hover:brightness-110" :
        variant === "secondary" ? "bg-slate-100 text-slate-900 hover:bg-slate-200" :
        "bg-slate-900 text-white hover:bg-slate-800";
      
      return (
        <button {...props} className={`${base} ${styles} ${className}`}>
          <span className="flex items-center gap-2 text-inherit">{children}</span>
        </button>
      );
    };

    const SmallBtn = ({ className="", children, ...props }) => (
      <button {...props} className={`p-2 rounded-xl hover:bg-slate-100 transition flex-shrink-0 flex items-center justify-center ${className}`}>
        {children}
      </button>
    );

    const TabBtn = ({ active, icon, label, onClick }) => (
      <button onClick={onClick}
        className={`flex items-center gap-3 px-4 py-3 rounded-2xl font-black transition w-full text-right border
        ${active ? "bg-teal-700/10 text-teal-800 border-teal-700/20" : "text-slate-600 hover:bg-white border-transparent hover:border-slate-200"}`}>
        <Icon name={icon} size={20} /><span className="text-inherit">{label}</span>
      </button>
    );

    const SectionTitle = ({ icon, title, desc }) => (
      <div className="flex items-start gap-3 mb-4">
        <div className="p-2.5 rounded-xl bg-teal-700/10 text-teal-700 border border-teal-700/20">
          <Icon name={icon} size={20}/>
        </div>
        <div>
          <div className="font-black text-slate-900 text-lg leading-tight">{title}</div>
          {desc && <div className="text-xs text-slate-500 font-bold mt-1">{desc}</div>}
        </div>
      </div>
    );

    /***********************
     * Main App
     ***********************/
    function App(){
      const [menuOpen, setMenuOpen] = useState(false);
      const [activeTab, setActiveTab] = useState("dashboard");
      const [filterDate, setFilterDate] = useState(getToday());

      // Only Current User is saved locally
      const [currentUser, setCurrentUser] = useLocalStorageState("alamal_current_user", null);

      // All Data Synced to Firebase
      const [users, setUsers, l1] = useFirebaseState("alamal_users", DEFAULT_ADMIN);
      const [company, setCompany, l2] = useFirebaseState("alamal_company", { name: "الأمل جروب", short: "الأمل", phone: "", address: "" });
      const [products, setProducts, l3] = useFirebaseState("pc_products", []);
      const [suppliers, setSuppliers, l4] = useFirebaseState("pc_suppliers", []);
      const [customers, setCustomers, l5] = useFirebaseState("pc_customers", []);
      const [drivers, setDrivers, l6] = useFirebaseState("pc_drivers", []);
      const [purchases, setPurchases, l7] = useFirebaseState("pc_purchases", []);
      const [sales, setSales, l8] = useFirebaseState("pc_sales", []);
      const [expenses, setExpenses, l9] = useFirebaseState("pc_expenses", []);
      const [treasuryTx, setTreasuryTx, l10] = useFirebaseState("pc_treasury", []);

      const isDbLoaded = l1 && l2 && l3 && l4 && l5 && l6 && l7 && l8 && l9 && l10;

      // Forms
      const [loginUsername, setLoginUsername] = useState("");
      const [loginPin, setLoginPin] = useState("");
      const [loginErr, setLoginErr] = useState("");

      const [purchaseForm, setPurchaseForm] = useState({ date:getToday(), supplier:"", product:"", quantity:"", buyPrice:"", paid:"", loss:"0", notes:"" });
      const [saleForm, setSaleForm] = useState({ date:getToday(), customer:"", driver:"", product:"", quantity:"", sellPrice:"", paid:"", notes:"" });
      const [expenseForm, setExpenseForm] = useState({ date:getToday(), category:"", driver:"", amount:"", notes:"" });
      const [txForm, setTxForm] = useState({ date:getToday(), type:"in", amount:"", note:"" });
      const [personForm, setPersonForm] = useState({ name:"", phone:"" });
      const [productForm, setProductForm] = useState({ category:"", name:"", unit:"" });
      const [newUserForm, setNewUserForm] = useState({ username:"", displayName:"", pin:"", role:"clerk" });

      const [receiptDate, setReceiptDate] = useState(getToday());
      const [receiptCustomer, setReceiptCustomer] = useState("");
      const [receiptDriver, setReceiptDriver] = useState("");
      const [receiptErr, setReceiptErr] = useState("");
      const [receiptPreview, setReceiptPreview] = useState(null);

      const [myPin, setMyPin] = useState({ current:"", newPin:"" });
      const [myPinMsg, setMyPinMsg] = useState("");

      const [err, setErr] = useState({});
      const setFormErr = (key, msg) => setErr(e => ({...e, [key]: msg}));

      const isAdmin = currentUser?.role === "admin";
      const productUnit = (name) => products.find(p => p.name === name)?.unit || "";

      useEffect(() => {
        if (currentUser && !canSeeTab(currentUser.role, activeTab)) {
          setActiveTab(ROLE_TABS[currentUser.role]?.[0] || "sales");
        }
      }, [currentUser, activeTab]);

      // Ensure safe arrays
      const safeProducts = products || [];
      const safePurchases = purchases || [];
      const safeSales = sales || [];
      const safeExpenses = expenses || [];
      const safeTx = treasuryTx || [];
      const safeCustomers = customers || [];
      const safeSuppliers = suppliers || [];
      const safeDrivers = drivers || [];
      const safeUsers = users || DEFAULT_ADMIN;

      // Stock Logic
      const stockByProduct = useMemo(() => {
        const map = {};
        safeProducts.forEach(p => map[p.name] = 0);
        safePurchases.forEach(p => { map[p.product] = (map[p.product]||0) + toNumber(p.quantity) - toNumber(p.loss||0); });
        safeSales.forEach(s => { map[s.product] = (map[s.product]||0) - toNumber(s.quantity); });
        return map;
      }, [safeProducts, safePurchases, safeSales]);

      const totalStock = useMemo(() => Object.values(stockByProduct).reduce((a,b)=>a+toNumber(b),0), [stockByProduct]);

      // Treasury stats
      const treasuryStats = useMemo(() => {
        let totalIn = 0, totalOut = 0;
        safeSales.forEach(s => totalIn += toNumber(s.paid));
        safePurchases.forEach(p => totalOut += toNumber(p.paid));
        safeExpenses.forEach(e => totalOut += toNumber(e.amount));
        safeTx.forEach(t => { if(t.type === "in") totalIn += toNumber(t.amount); else totalOut += toNumber(t.amount); });
        return { totalIn, totalOut, balance: totalIn - totalOut };
      }, [safeSales, safePurchases, safeExpenses, safeTx]);

      // Smart Dashboard KPIs
      const smartKPIs = useMemo(() => {
        let totalRevenue = 0, cogs = 0, lossValue = 0;
        let totalExpenses = safeExpenses.reduce((s,e)=>s+toNumber(e.amount), 0);
        let owedToSuppliers = safePurchases.reduce((s,p)=>s+toNumber(p.debt),0);
        let owedFromCustomers = safeSales.reduce((s,x)=>s+toNumber(x.debt),0);

        const productCost = {};
        safeProducts.forEach(p => {
           const pPurchases = safePurchases.filter(x => x.product === p.name);
           const tQty = pPurchases.reduce((s,x)=>s+toNumber(x.quantity),0);
           const tVal = pPurchases.reduce((s,x)=>s+toNumber(x.total),0);
           const tLoss = pPurchases.reduce((s,x)=>s+toNumber(x.loss),0);
           
           const avgCost = tQty > 0 ? tVal / tQty : 0;
           productCost[p.name] = avgCost;
           lossValue += (tLoss * avgCost); 
        });

        safeSales.forEach(s => {
           totalRevenue += toNumber(s.total);
           cogs += toNumber(s.quantity) * (productCost[s.product] || 0);
        });

        const grossProfit = totalRevenue - cogs;
        const netProfit = grossProfit - totalExpenses - lossValue;
        const todaySales = filterDate ? safeSales.filter(s => s.date === filterDate).reduce((s,x)=>s+toNumber(x.total),0) : 0;
        const todayExpenses = filterDate ? safeExpenses.filter(e => e.date === filterDate).reduce((s,e)=>s+toNumber(e.amount),0) : 0;

        return { totalRevenue, cogs, grossProfit, netProfit, lossValue, owedToSuppliers, owedFromCustomers, todaySales, todayExpenses };
      }, [safePurchases, safeSales, safeExpenses, safeProducts, filterDate]);

      // Settlements
      const settlements = useMemo(() => {
        if (!filterDate) return [];
        const map = {};
        safeSales.filter(s=>s.date===filterDate).forEach(s=>{
          map[s.driver] ||= { name:s.driver, cash:0, expenses:0, total:0, qty:0, debt:0, count:0 };
          map[s.driver].cash += toNumber(s.paid); map[s.driver].total += toNumber(s.total);
          map[s.driver].qty += toNumber(s.quantity); map[s.driver].debt += toNumber(s.debt); map[s.driver].count += 1;
        });
        safeExpenses.filter(e=>e.date===filterDate).forEach(e=>{
          if (!e.driver) return;
          map[e.driver] ||= { name:e.driver, cash:0, expenses:0, total:0, qty:0, debt:0, count:0 };
          map[e.driver].expenses += toNumber(e.amount);
        });
        return Object.values(map).map(d => ({...d, net: d.cash - d.expenses})).sort((a,b)=>b.net-a.net);
      }, [safeSales, safeExpenses, filterDate]);

      /***********************
       * Auth Actions
       ***********************/
      function login(){
        setLoginErr("");
        const u = safeUsers.find(x => x.username.toLowerCase() === (loginUsername||"").trim().toLowerCase());
        if (!u || (loginPin||"").trim() !== u.pin) return setLoginErr("بيانات الدخول غير صحيحة.");
        setCurrentUser({ id:u.id, username:u.username, displayName:u.displayName, role:u.role });
        setActiveTab(u.role==="clerk" ? "sales" : "dashboard");
        setLoginPin("");
      }
      function logout(){ setCurrentUser(null); setActiveTab("sales"); setReceiptPreview(null); }

      /***********************
       * Operations
       ***********************/
      function canDeleteRow(row){
        if(!currentUser) return false;
        if(isAdmin) return true;
        return row?.createdBy === currentUser.displayName;
      }

      function removeRow(kind, id){
        let row = null;
        if(kind==="purchase") row = safePurchases.find(x=>x.id===id);
        if(kind==="sale") row = safeSales.find(x=>x.id===id);
        if(kind==="expense") row = safeExpenses.find(x=>x.id===id);
        if(kind==="tx") row = safeTx.find(x=>x.id===id);

        if(!isAdmin && ["customer","supplier","driver","product","tx","user"].includes(kind)) return alert("غير مسموح.");
        if(["purchase","sale","expense"].includes(kind) && !canDeleteRow(row)) return alert("مسموح تحذف اللي أنت سجّلته فقط.");

        if(!confirm("تأكيد الحذف من قاعدة البيانات؟")) return;

        if(kind==="purchase") setPurchases(p=>(p||[]).filter(x=>x.id!==id));
        if(kind==="sale") setSales(p=>(p||[]).filter(x=>x.id!==id));
        if(kind==="expense") setExpenses(p=>(p||[]).filter(x=>x.id!==id));
        if(kind==="tx") setTreasuryTx(p=>(p||[]).filter(x=>x.id!==id));
        if(kind==="customer") setCustomers(p=>(p||[]).filter(x=>x.id!==id));
        if(kind==="supplier") setSuppliers(p=>(p||[]).filter(x=>x.id!==id));
        if(kind==="driver") setDrivers(p=>(p||[]).filter(x=>x.id!==id));
        if(kind==="product") setProducts(p=>(p||[]).filter(x=>x.id!==id));
        if(kind==="user") setUsers(p=>(p||[]).filter(x=>x.id!==id));
      }

      function addPurchase(){
        setFormErr("purchase","");
        const {date, supplier, product, quantity:q, buyPrice:bp, paid:pd, loss:ls, notes} = purchaseForm;
        const quantity = toNumber(q), buyPrice = toNumber(bp), paid = toNumber(pd), loss = toNumber(ls);
        if(!date||!supplier||!product||quantity<=0||buyPrice<=0) return setFormErr("purchase","أكمل البيانات الأساسية");
        const total = quantity*buyPrice;
        setPurchases(p => [{ id:Date.now(), createdBy:currentUser.displayName, date, supplier, product, quantity, buyPrice, total, paid, debt:computeDebt(total, paid), loss, notes }, ...(p||[])]);
        setPurchaseForm(f=>({...f, quantity:"", buyPrice:"", paid:"", loss:"0", notes:""}));
      }

      function addSale(){
        setFormErr("sale","");
        const {date, customer, driver, product, quantity:q, sellPrice:sp, paid:pd, notes} = saleForm;
        const quantity = toNumber(q), sellPrice = toNumber(sp), paid = toNumber(pd);
        if(!date||!customer||!driver||!product||quantity<=0||sellPrice<=0) return setFormErr("sale","أكمل البيانات");
        if(quantity > (stockByProduct[product]||0)) return setFormErr("sale",`المخزون لا يكفي (${formatQty(stockByProduct[product])} متاح)`);
        const total = quantity*sellPrice;
        setSales(p => [{ id:Date.now(), createdBy:currentUser.displayName, date, customer, driver, product, quantity, sellPrice, total, paid, debt:computeDebt(total, paid), notes }, ...(p||[])]);
        setSaleForm(f=>({...f, quantity:"", sellPrice:"", paid:"", notes:""}));
      }

      function addExpense(){
        setFormErr("expense","");
        const {date, category, driver, amount:am, notes} = expenseForm;
        const amount = toNumber(am);
        if(!date||!category||amount<=0) return setFormErr("expense","أدخل التاريخ والنوع والمبلغ");
        setExpenses(p => [{ id:Date.now(), createdBy:currentUser.displayName, date, category, driver, amount, notes }, ...(p||[])]);
        setExpenseForm(f=>({...f, amount:"", notes:""}));
      }

      function addTx(){
        setFormErr("tx","");
        const {date, type, amount:am, note} = txForm;
        const amount = toNumber(am);
        if(!date||!amount) return setFormErr("tx","أدخل التاريخ والمبلغ");
        setTreasuryTx(p => [{ id:Date.now(), createdBy:currentUser.displayName, date, type, amount, note }, ...(p||[])]);
        setTxForm(f=>({...f, amount:"", note:""}));
      }

      function addPerson(kind){
        setFormErr("person","");
        const name = (personForm.name||"").trim(); const phone = (personForm.phone||"").trim();
        if(!name) return setFormErr("person","يجب إدخال الاسم");
        const newObj = { id:Date.now(), name, phone };
        if(kind==="customer"){ if(safeCustomers.find(c=>c.name===name)) return setFormErr("person","الاسم موجود مسبقاً"); setCustomers(p=>[newObj, ...(p||[])]); }
        else if(kind==="supplier"){ if(safeSuppliers.find(c=>c.name===name)) return setFormErr("person","الاسم موجود مسبقاً"); setSuppliers(p=>[newObj, ...(p||[])]); }
        else { if(safeDrivers.find(c=>c.name===name)) return setFormErr("person","الاسم موجود مسبقاً"); setDrivers(p=>[newObj, ...(p||[])]); }
        setPersonForm({name:"", phone:""});
      }

      function addProduct(){
        setFormErr("products","");
        const category = (productForm.category||"").trim(); const name = (productForm.name||"").trim(); const unit = (productForm.unit||"").trim();
        if(!category || !name || !unit) return setFormErr("products","أدخل القسم + الاسم + الوحدة");
        if(safeProducts.find(p=>p.name===name)) return setFormErr("products","اسم المنتج موجود مسبقاً");
        setProducts(p=>[{ id:Date.now(), category, name, unit }, ...(p||[])]);
        setProductForm({category:"", name:"", unit:""});
      }

      function createUser(){
        setFormErr("userAdd","");
        const {username, displayName, pin, role} = newUserForm;
        if(!username.trim() || !displayName.trim() || !pin.trim()) return setFormErr("userAdd", "يرجى ملء جميع البيانات");
        if(!/^[0-9]{4,8}$/.test(pin)) return setFormErr("userAdd", "رمز الـ PIN يجب أن يكون أرقام فقط (4 إلى 8 أرقام)");
        if(safeUsers.find(u => u.username.toLowerCase() === username.trim().toLowerCase())) return setFormErr("userAdd", "اسم المستخدم موجود مسبقاً");
        
        setUsers(u => [...(u||[]), { id:Date.now(), username:username.trim(), displayName:displayName.trim(), pin:pin.trim(), role }]);
        setNewUserForm({username:"", displayName:"", pin:"", role:"clerk"});
        setFormErr("userAdd", "✅ تم إنشاء الحساب ومزامنته السحابية بنجاح");
      }

      function buildReceipt(){
        setReceiptErr(""); setReceiptPreview(null);
        if(!receiptDate) return setReceiptErr("اختار تاريخ.");
        if(!receiptCustomer) return setReceiptErr("اختار عميل.");
        const rows = safeSales.filter(s => s.date === receiptDate && s.customer === receiptCustomer && (!receiptDriver || s.driver === receiptDriver));
        if(rows.length === 0) return setReceiptErr("لا توجد فواتير لهذا العميل في التاريخ المحدد.");
        const totals = rows.reduce((acc, r) => { acc.total += toNumber(r.total); acc.paid += toNumber(r.paid); acc.debt += toNumber(r.debt); return acc; }, { total:0, paid:0, debt:0 });
        setReceiptPreview({ date: receiptDate, customer: receiptCustomer, driver: receiptDriver || "الكل", rows, totals });
      }

      function printReceipt(){
        if(!receiptPreview) return;
        const w = window.open("", "_blank", "width=900,height=700");
        if(!w) return alert("الـ Pop-up اتمنع. افتح السماح للـ Pop-ups وجرب تاني.");
        const { date, customer, driver, rows, totals } = receiptPreview;
        const htmlRows = rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.product}</td><td>${formatQty(r.quantity)} ${productUnit(r.product)}</td><td>${formatMoney(r.sellPrice)}</td><td>${formatMoney(r.total)}</td><td>${formatMoney(r.paid)}</td><td>${formatMoney(r.debt)}</td></tr>`).join("");
        const doc = `
          <!doctype html><html lang="ar" dir="rtl"><head><meta charset="UTF-8" /><title>إيصال - ${customer}</title>
          <style>body{font-family:Cairo,sans-serif;padding:18px;color:#0f172a}.box{border:1px solid #e2e8f0;border-radius:14px;padding:16px}.head{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}h1{margin:0;font-size:18px}.muted{color:#64748b;font-size:12px;font-weight:700}table{width:100%;border-collapse:collapse;margin-top:14px}th,td{border-bottom:1px solid #e2e8f0;padding:8px;font-size:12px;text-align:right}th{background:#f8fafc;color:#475569}.totals{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:14px}.tcard{border:1px solid #e2e8f0;border-radius:12px;padding:10px;background:#fff}.tlabel{font-size:11px;color:#64748b;font-weight:800;margin-bottom:4px}.tval{font-size:16px;font-weight:900}.green{color:#047857}.red{color:#b91c1c}.foot{margin-top:14px;font-size:11px;color:#64748b;font-weight:700}@media print{body{padding:0}.box{border:none}}</style>
          </head><body><div class="box"><div class="head"><div><h1>${company.name} — إيصال مجمّع</h1><div class="muted">عميل: ${customer} • موزع: ${driver}</div><div class="muted">تاريخ: ${date}</div></div><div class="muted">${company.phone?`ت: ${company.phone}<br/>`:``}${company.address?`${company.address}`:``}</div></div><table><thead><tr><th>#</th><th>الصنف</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th><th>مدفوع</th><th>متبقي</th></tr></thead><tbody>${htmlRows}</tbody></table><div class="totals"><div class="tcard"><div class="tlabel">الإجمالي</div><div class="tval">${formatMoney(totals.total)} ج</div></div><div class="tcard"><div class="tlabel">المدفوع</div><div class="tval green">${formatMoney(totals.paid)} ج</div></div><div class="tcard"><div class="tlabel">المتبقي (آجل)</div><div class="tval red">${formatMoney(totals.debt)} ج</div></div></div><div class="foot">إصدار: ${currentUser.displayName} — ${new Date().toLocaleString("ar-EG")}</div></div></body></html>`;
        w.document.open(); w.document.write(doc); w.document.close();
        w.focus(); setTimeout(()=>w.print(), 350);
      }

      function changeMyPin(){
        setMyPinMsg("");
        const current = (myPin.current||"").trim(); const newPin = (myPin.newPin||"").trim();
        if(!/^[0-9]{4,8}$/.test(newPin)) return setMyPinMsg("الـ PIN الجديد لازم يكون من 4 لـ 8 أرقام.");
        const me = safeUsers.find(u => u.username === currentUser.username);
        if(!me) return setMyPinMsg("مستخدم غير موجود.");
        if(me.pin !== current) return setMyPinMsg("الـ PIN الحالي غير صحيح.");
        setUsers(arr => arr.map(u => u.username === me.username ? ({...u, pin:newPin}) : u));
        setMyPin({ current:"", newPin:"" });
        setMyPinMsg("✅ تم تغيير الـ PIN الخاص بك سحابياً.");
      }

      function resetAllData(){
        if(!confirm("تحذير: هيمسح كل البيانات من السيرفر نهائياً. متأكد؟")) return;
        setProducts([]); setSuppliers([]); setCustomers([]); setDrivers([]);
        setPurchases([]); setSales([]); setExpenses([]); setTreasuryTx([]);
        alert("تم تفريغ البيانات السحابية بنجاح.");
      }

      /***********************
       * Navigation Configuration
       ***********************/
      const navItemsBase = [
        { id:"dashboard",  icon:"dashboard", label:"الرئيسية (Dashboard)", group:"تقارير وماليات" },
        { id:"treasury",   icon:"coins",     label:"الخزينة (الماليات)", group:"تقارير وماليات" },
        { id:"settlements",icon:"users",     label:"تقفيل اليومية (الموزعين)", group:"تقارير وماليات" },
        { id:"sales",      icon:"truck",     label:"تسجيل المبيعات", group:"عمليات يومية" },
        { id:"purchases",  icon:"cart",      label:"تسجيل المشتريات", group:"عمليات يومية" },
        { id:"expenses",   icon:"wallet",    label:"إدارة المصروفات", group:"عمليات يومية" },
        { id:"receipts",   icon:"printer",   label:"طباعة الإيصالات", group:"عمليات يومية" },
        { id:"products",   icon:"package",   label:"المنتجات والمخزون", group:"أشخاص وأصناف" },
        { id:"customers",  icon:"user",      label:"قائمة العملاء", group:"أشخاص وأصناف" },
        { id:"suppliers",  icon:"briefcase", label:"الموردين والمعامل", group:"أشخاص وأصناف" },
        { id:"drivers",    icon:"car",       label:"طاقم التوزيع", group:"أشخاص وأصناف" },
        { id:"users_manage",icon:"userPlus", label:"إدارة المستخدمين", group:"إدارة" },
        { id:"settings",   icon:"settings",  label:"إعدادات النظام", group:"إدارة" },
      ];

      const navItems = navItemsBase.filter(t => canSeeTab(currentUser?.role, t.id));
      const groupedNav = useMemo(() => { const g={}; navItems.forEach(i=>(g[i.group]||=[]).push(i)); return g; }, [navItems]);
      const titleByTab = useMemo(() => navItems.reduce((acc, curr) => ({...acc, [curr.id]: curr.label}), {}), [navItems]);

      function navigate(id){ setActiveTab(id); setMenuOpen(false); window.scrollTo(0,0); }
      const showDateFilter = ["sales","purchases","expenses","receipts","dashboard","settlements"].includes(activeTab) && (isAdmin || ["sales","purchases","expenses","receipts"].includes(activeTab));

      /***********************
       * Loading Screen (Important for Firebase)
       ***********************/
       if (!isDbLoaded) {
        return (
          <div className="min-h-screen flex flex-col items-center justify-center p-4 gap-6 bg-slate-50">
             <div className="p-4 rounded-3xl bg-teal-700 text-white shadow-xl animate-pulse">
               <Icon name="cloudSync" size={48} />
             </div>
             <div className="text-center">
               <h2 className="text-2xl font-black text-slate-800 mb-2">جاري الاتصال بالسيرفر...</h2>
               <p className="text-sm font-bold text-slate-500">جلب بيانات شركة الأمل جروب من قاعدة البيانات السحابية</p>
             </div>
          </div>
        );
      }

      /***********************
       * Auth Screen
       ***********************/
      if(!currentUser){
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="w-full max-w-md bg-white rounded-3xl shadow-soft p-6 sm:p-8 border border-slate-100 relative overflow-hidden">
              <div className="absolute top-0 right-0 w-full h-1 bg-gradient-to-r from-teal-500 to-teal-700"></div>
              <div className="flex items-center gap-4 mb-8">
                <div className="p-3 rounded-2xl bg-teal-700 text-white shadow-soft"><Icon name="brand" size={32}/></div>
                <div>
                  <h1 className="text-2xl font-black text-slate-900 leading-none">{company.name}</h1>
                  <p className="text-sm text-teal-700 font-black mt-1 flex items-center gap-1"><Icon name="cloudSync" size={14}/> نظام سحابي متصل</p>
                </div>
              </div>
              {loginErr && <Notice variant="warn"><div className="font-bold">{loginErr}</div></Notice>}
              <div className="grid gap-4 mt-6">
                <Field label="اسم المستخدم (Username)">
                  <Input value={loginUsername} onChange={e=>setLoginUsername(e.target.value)} placeholder="مثال: admin" autoComplete="username" />
                </Field>
                <Field label="رمز الدخول (PIN)">
                  <Input value={loginPin} onChange={e=>setLoginPin(e.target.value)} type="password" inputMode="numeric" placeholder="••••" autoComplete="current-password" />
                </Field>
                <Button onClick={login} className="mt-2 py-4 text-lg shadow-md">
                  <Icon name="lock" size={20}/> تسجيل الدخول السحابي
                </Button>
                
                <div className="mt-4 text-center text-xs text-slate-500 font-bold bg-slate-50 p-3 rounded-xl border border-slate-200">
                  للدخول الافتراضي للمالك: اسم المستخدم <b>admin</b> وكلمة السر <b>0000</b>
                </div>
              </div>
            </div>
          </div>
        );
      }

      /***********************
       * Main Layout
       ***********************/
      return (
        <div className="min-h-screen mobile-main-pad lg:pb-0">
          <header className="sticky top-0 z-30 bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm">
            <div className="px-4 py-3 flex items-center justify-between gap-3">
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-xl bg-teal-700 text-white shadow-sm lg:hidden"><Icon name="brand" size={24}/></div>
                <div className="hidden lg:flex p-2 rounded-xl bg-teal-700 text-white shadow-sm"><Icon name="brand" size={26}/></div>
                <div>
                  <div className="font-black text-slate-900 text-lg leading-none flex items-center gap-2">
                    {company.name} <Icon name="cloudSync" size={16} className="text-teal-600"/>
                  </div>
                  <div className="text-xs text-teal-700 font-bold mt-1">{titleByTab[activeTab]}</div>
                </div>
              </div>
              <div className="flex items-center gap-2 sm:gap-4">
                <div className="hidden sm:flex flex-col items-end">
                  <span className="text-xs text-slate-500 font-black">المخزون الإجمالي</span>
                  <span className="font-black text-slate-900 leading-none">{formatQty(totalStock)}</span>
                </div>
                <div className="flex items-center gap-2 bg-slate-100 rounded-xl px-3 py-2">
                  <span className="font-black text-slate-800 text-sm">{currentUser.displayName}</span>
                  <span className={`text-[10px] font-black px-2 py-0.5 rounded-full ${isAdmin?'bg-teal-200 text-teal-900':'bg-amber-200 text-amber-900'}`}>{isAdmin?"مدير":"مسجل"}</span>
                </div>
                <button className="p-2 rounded-xl hover:bg-slate-100 hidden sm:block text-slate-500" onClick={logout}><Icon name="logout" size={20}/></button>
              </div>
            </div>
            {showDateFilter && (
              <div className="px-4 pb-3 bg-white/50 border-t border-slate-100">
                <div className="flex items-center gap-2 max-w-sm mt-2">
                  <span className="text-xs font-black text-slate-500 whitespace-nowrap">تاريخ العرض:</span>
                  <Input type="date" value={filterDate} onChange={(e)=>setFilterDate(e.target.value)} className="!py-1.5 !px-2 !text-sm" />
                </div>
              </div>
            )}
          </header>

          <div className="lg:flex max-w-[1600px] mx-auto">
            <aside className="hidden lg:block w-72 p-4 sticky top-[72px] h-[calc(100vh-72px)] overflow-y-auto">
              <div className="space-y-6">
                {Object.entries(groupedNav).map(([group, items]) => (
                  <div key={group}>
                    <div className="text-xs text-slate-400 font-black mb-3 px-2 uppercase tracking-wider">{group}</div>
                    <div className="space-y-1.5">{items.map(t => <TabBtn key={t.id} active={activeTab===t.id} icon={t.icon} label={t.label} onClick={()=>navigate(t.id)} />)}</div>
                  </div>
                ))}
              </div>
            </aside>

            {menuOpen && (
              <div className="fixed inset-0 z-50 bg-white lg:hidden flex flex-col pb-safe animate-in fade-in">
                <div className="flex items-center justify-between p-4 border-b border-slate-100 bg-slate-50">
                  <div className="font-black text-lg">كل الأقسام</div>
                  <button className="p-2 rounded-full bg-white shadow-sm text-slate-600" onClick={()=>setMenuOpen(false)}><Icon name="x" size={24}/></button>
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-6 pb-24">
                  {Object.entries(groupedNav).map(([group, items]) => (
                    <div key={group}>
                      <div className="text-xs text-slate-400 font-black mb-3 uppercase">{group}</div>
                      <div className="grid grid-cols-2 gap-2">
                        {items.map(t => (
                          <button key={t.id} onClick={()=>navigate(t.id)} className={`flex flex-col items-center justify-center gap-2 p-4 rounded-2xl border text-center transition active:scale-95 ${activeTab===t.id?'bg-teal-50 border-teal-200 text-teal-800':'bg-white border-slate-100 text-slate-700'}`}>
                            <Icon name={t.icon} size={28} className={activeTab===t.id?'text-teal-600':'text-slate-400'}/>
                            <span className="text-xs font-black">{t.label.split(' ')[0]}</span>
                          </button>
                        ))}
                      </div>
                    </div>
                  ))}
                  <div className="pt-4 border-t border-slate-100 space-y-2">
                    <Button variant="danger" className="w-full" onClick={logout}><Icon name="logout"/> تسجيل الخروج</Button>
                  </div>
                </div>
              </div>
            )}

            <main className="flex-1 p-4 sm:p-6 lg:max-w-[calc(100%-18rem)]">
              
              {/* Dashboard */}
              {activeTab==="dashboard" && isAdmin && (
                <div className="space-y-4 animate-in fade-in">
                  <Card className="bg-slate-900 text-white border-slate-800">
                    <SectionTitle icon="dashboard" title="لوحة التحكم الذكية" desc="تحليل تلقائي متقدم بناءً على المزامنة السحابية للبيانات" />
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
                      <div className="bg-white/10 p-4 rounded-2xl">
                        <div className="text-sm text-slate-400 font-black mb-1">صافي الأرباح المتوقعة</div>
                        <div className={`text-3xl font-black ${smartKPIs.netProfit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                          {formatMoney(smartKPIs.netProfit)} <span className="text-lg">ج</span>
                        </div>
                      </div>
                      <div className="bg-white/10 p-4 rounded-2xl">
                        <div className="text-sm text-slate-400 font-black mb-1">الرصيد الفعلي بالخزينة</div>
                        <div className="text-3xl font-black text-white">{formatMoney(treasuryStats.balance)} <span className="text-lg">ج</span></div>
                      </div>
                      <div className="bg-white/10 p-4 rounded-2xl">
                        <div className="text-sm text-red-300 font-black mb-1">خسائر (نافوق/هالك)</div>
                        <div className="text-3xl font-black text-red-400">{formatMoney(smartKPIs.lossValue)} <span className="text-lg">ج</span></div>
                      </div>
                    </div>
                  </Card>

                  <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                    <Card className="!p-4 bg-teal-50/50 border-teal-100">
                      <div className="text-xs text-teal-700 font-black mb-1">إجمالي المبيعات للآن</div>
                      <div className="text-xl sm:text-2xl font-black text-teal-800">{formatMoney(smartKPIs.totalRevenue)}</div>
                    </Card>
                    <Card className="!p-4 bg-red-50/50 border-red-100">
                      <div className="text-xs text-red-700 font-black mb-1">إجمالي المصروفات</div>
                      <div className="text-xl sm:text-2xl font-black text-red-800">{formatMoney(smartKPIs.todayExpenses)}</div>
                    </Card>
                    <Card className="!p-4 bg-amber-50/50 border-amber-100">
                      <div className="text-xs text-amber-700 font-black mb-1">ديون لنا (السوق)</div>
                      <div className="text-xl sm:text-2xl font-black text-amber-800">{formatMoney(smartKPIs.owedFromCustomers)}</div>
                    </Card>
                    <Card className="!p-4 bg-rose-50/50 border-rose-100">
                      <div className="text-xs text-rose-700 font-black mb-1">ديون علينا (للموردين)</div>
                      <div className="text-xl sm:text-2xl font-black text-rose-800">{formatMoney(smartKPIs.owedToSuppliers)}</div>
                    </Card>
                  </div>
                </div>
              )}

              {/* Users Manage */}
              {activeTab==="users_manage" && isAdmin && (
                <div className="space-y-4 animate-in fade-in">
                  <Card>
                    <SectionTitle icon="userPlus" title="إدارة حسابات الموظفين السحابية" desc="تتم مزامنة الحسابات فوراً مع السيرفر، ويمكن للموظف تسجيل الدخول من جهازه." />
                    {err.userAdd && <Notice variant={err.userAdd.includes("✅") ? "info" : "warn"}>{err.userAdd}</Notice>}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 mt-4 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                      <Field label="الاسم المعروض"><Input value={newUserForm.displayName} onChange={e=>setNewUserForm(f=>({...f, displayName:e.target.value}))} placeholder="أحمد - كاشير" /></Field>
                      <Field label="اسم الدخول"><Input value={newUserForm.username} onChange={e=>setNewUserForm(f=>({...f, username:e.target.value}))} placeholder="ahmed" /></Field>
                      <Field label="كلمة السر (PIN)"><Input value={newUserForm.pin} onChange={e=>setNewUserForm(f=>({...f, pin:e.target.value}))} placeholder="4 أرقام فأكثر" type="password" inputMode="numeric" /></Field>
                      <Field label="الصلاحية">
                        <Select value={newUserForm.role} onChange={e=>setNewUserForm(f=>({...f, role:e.target.value}))}>
                          <option value="clerk">موظف بيانات (Clerk)</option>
                          <option value="admin">مدير (Admin)</option>
                        </Select>
                      </Field>
                      <div className="flex items-end"><Button onClick={createUser} className="w-full">إضافة الموظف</Button></div>
                    </div>

                    <div className="mt-6 space-y-3">
                      {safeUsers.map(u => (
                        <div key={u.id} className="flex justify-between items-center bg-white border border-slate-200 p-4 rounded-xl shadow-sm">
                          <div>
                            <div className="font-black text-lg text-slate-800">{u.displayName}</div>
                            <div className="text-xs text-slate-500 font-bold mt-1">الدخول: {u.username} • الصلاحية: {u.role==="admin"?"مدير":"موظف"}</div>
                          </div>
                          {u.id !== currentUser.id && (
                            <button onClick={()=>removeRow("user", u.id)} className="text-red-500 hover:bg-red-50 p-2 rounded-lg"><Icon name="trash"/></button>
                          )}
                        </div>
                      ))}
                    </div>
                  </Card>
                </div>
              )}

              {/* Treasury */}
              {activeTab==="treasury" && isAdmin && (
                <div className="space-y-4 animate-in fade-in">
                  <Card className="bg-slate-900 text-white">
                    <SectionTitle icon="coins" title="الخزينة العامة" desc="الرصيد الفعلي بناءً على المزامنة" />
                    <div className="grid grid-cols-3 gap-3 sm:gap-4 text-center mt-6">
                      <div className="bg-white/10 rounded-2xl p-3"><div className="text-xs text-slate-400 mb-1">إجمالي الوارد</div><div className="text-xl font-black text-emerald-400">{formatMoney(treasuryStats.totalIn)}</div></div>
                      <div className="bg-white/10 rounded-2xl p-3"><div className="text-xs text-slate-400 mb-1">إجمالي الصادر</div><div className="text-xl font-black text-red-400">{formatMoney(treasuryStats.totalOut)}</div></div>
                      <div className="bg-teal-600 rounded-2xl p-3"><div className="text-xs text-teal-100 mb-1">الرصيد الحالي</div><div className="text-xl font-black text-white">{formatMoney(treasuryStats.balance)}</div></div>
                    </div>
                  </Card>

                  <Card>
                    <h3 className="font-black text-lg mb-4">تسوية كاش يدوي (إيداع / سحب)</h3>
                    {err.tx && <Notice variant="warn">{err.tx}</Notice>}
                    <div className="grid grid-cols-2 sm:grid-cols-5 gap-3">
                      <Field label="التاريخ" className="col-span-2 sm:col-span-1"><Input type="date" value={txForm.date} onChange={e=>setTxForm(f=>({...f,date:e.target.value}))}/></Field>
                      <Field label="النوع">
                        <Select value={txForm.type} onChange={e=>setTxForm(f=>({...f,type:e.target.value}))}>
                          <option value="in">إيداع (+)</option><option value="out">سحب (-)</option>
                        </Select>
                      </Field>
                      <Field label="المبلغ"><Input type="number" value={txForm.amount} onChange={e=>setTxForm(f=>({...f,amount:e.target.value}))} placeholder="1000" /></Field>
                      <Field label="البيان" className="col-span-2"><Input value={txForm.note} onChange={e=>setTxForm(f=>({...f,note:e.target.value}))} placeholder="سبب التسوية..." /></Field>
                      <div className="col-span-2 sm:col-span-5"><Button onClick={addTx} className="w-full sm:w-auto"><Icon name="plus"/> حفظ بالخزينة</Button></div>
                    </div>
                  </Card>

                  <Card>
                    <h3 className="font-black mb-3">سجل التسويات</h3>
                    <div className="space-y-2 sm:hidden">
                      {safeTx.map(t => (
                        <div key={t.id} className="border border-slate-100 rounded-xl p-3 flex justify-between items-center bg-slate-50">
                          <div><div className="text-xs text-slate-500">{t.date}</div><div className="font-black">{t.note || "-"}</div></div>
                          <div className="flex items-center gap-3">
                            <span className={`font-black text-lg ${t.type==='in'?'text-emerald-600':'text-red-600'}`}>{t.type==='in'?'+':'-'} {formatMoney(t.amount)}</span>
                            <SmallBtn onClick={()=>removeRow("tx", t.id)} className="text-red-500"><Icon name="trash" size={16}/></SmallBtn>
                          </div>
                        </div>
                      ))}
                    </div>
                    <div className="hidden sm:block table-wrap overflow-auto">
                      <table className="w-full text-right"><thead className="bg-slate-50 text-slate-500 text-sm"><tr><th className="p-3">حذف</th><th className="p-3">التاريخ</th><th className="p-3">النوع</th><th className="p-3">المبلغ</th><th className="p-3">البيان</th></tr></thead>
                        <tbody>
                          {safeTx.map(t => (
                            <tr key={t.id} className="border-t border-slate-100"><td className="p-3"><SmallBtn onClick={()=>removeRow("tx", t.id)} className="text-red-500"><Icon name="trash" size={18}/></SmallBtn></td><td className="p-3 font-bold">{t.date}</td><td className="p-3"><span className={`px-2 py-1 rounded-md text-xs font-black ${t.type==='in'?'bg-emerald-100 text-emerald-800':'bg-red-100 text-red-800'}`}>{t.type==='in'?'إيداع':'سحب'}</span></td><td className="p-3 font-black">{formatMoney(t.amount)}</td><td className="p-3 font-bold text-slate-600">{t.note}</td></tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </Card>
                </div>
              )}

              {/* Sales */}
              {activeTab==="sales" && (
                <div className="space-y-4 animate-in fade-in">
                  <Card>
                    <SectionTitle icon="truck" title="تسجيل فاتورة بيع جديدة" desc="يخصم من المخزون فوراً على جميع الأجهزة." />
                    {err.sale && <Notice variant="warn">{err.sale}</Notice>}
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                      <Field label="التاريخ"><Input type="date" value={saleForm.date} onChange={e=>setSaleForm(f=>({...f,date:e.target.value}))}/></Field>
                      <Field label="العميل">
                        <Select value={saleForm.customer} onChange={e=>setSaleForm(f=>({...f,customer:e.target.value}))}>
                          <option value="">اختار عميل</option>{safeCustomers.map(c=><option key={c.id} value={c.name}>{c.name}</option>)}
                        </Select>
                      </Field>
                      <Field label="الموزع">
                        <Select value={saleForm.driver} onChange={e=>setSaleForm(f=>({...f,driver:e.target.value}))}>
                          <option value="">اختار موزع</option>{safeDrivers.map(d=><option key={d.id} value={d.name}>{d.name}</option>)}
                        </Select>
                      </Field>
                      <Field label="المنتج">
                        <Select value={saleForm.product} onChange={e=>setSaleForm(f=>({...f,product:e.target.value}))}>
                          {safeProducts.map(p=><option key={p.id} value={p.name}>{p.name} ({formatQty(stockByProduct[p.name])} {p.unit})</option>)}
                        </Select>
                      </Field>
                      <Field label="الكمية"><Input type="number" value={saleForm.quantity} onChange={e=>setSaleForm(f=>({...f,quantity:e.target.value}))} placeholder="الكمية"/></Field>
                      <Field label="سعر الوحدة"><Input type="number" step="0.01" value={saleForm.sellPrice} onChange={e=>setSaleForm(f=>({...f,sellPrice:e.target.value}))}/></Field>
                      <Field label="المحصل كاش"><Input type="number" step="0.01" value={saleForm.paid} onChange={e=>setSaleForm(f=>({...f,paid:e.target.value}))} placeholder="المدفوع"/></Field>
                      <Field label="ملاحظات"><Input value={saleForm.notes} onChange={e=>setSaleForm(f=>({...f,notes:e.target.value}))} /></Field>
                      <div className="col-span-2 lg:col-span-4 mt-2">
                        <Button variant="success" onClick={addSale} className="w-full sm:w-auto py-3.5"><Icon name="plus"/> تأكيد البيع</Button>
                      </div>
                    </div>
                  </Card>
                  
                  <Card>
                    <SectionTitle icon="receipt" title={`سجل المبيعات (${filterDate})`} />
                    <div className="hidden sm:block table-wrap overflow-auto">
                      <table className="min-w-[1050px] w-full text-right"><thead className="bg-slate-50 text-slate-500 text-sm"><tr><th className="p-3">حذف</th><th className="p-3">التاريخ</th><th className="p-3">العميل</th><th className="p-3">الموزع</th><th className="p-3">الصنف</th><th className="p-3">الكمية</th><th className="p-3">السعر</th><th className="p-3">الإجمالي</th><th className="p-3">محصل</th>{isAdmin && <th className="p-3">آجل</th>}<th className="p-3">سجّل</th></tr></thead>
                        <tbody>
                          {safeSales.filter(s=>!filterDate || s.date===filterDate).map(s => (
                            <tr key={s.id} className="border-t border-slate-100 hover:bg-slate-50">
                              <td className="p-3">{canDeleteRow(s) ? (<SmallBtn onClick={()=>removeRow("sale", s.id)} className="text-red-500"><Icon name="trash" size={18}/></SmallBtn>) : <span className="text-slate-300">—</span>}</td>
                              <td className="p-3 text-sm font-bold">{s.date}</td><td className="p-3 font-black">{s.customer}</td><td className="p-3 text-slate-600">{s.driver}</td>
                              <td className="p-3 font-bold">{s.product}</td><td className="p-3 font-black">{formatQty(s.quantity)}</td><td className="p-3">{formatMoney(s.sellPrice)}</td>
                              <td className="p-3 font-black text-teal-700">{formatMoney(s.total)}</td><td className="p-3 font-black text-emerald-600">{formatMoney(s.paid)}</td>
                              {isAdmin && <td className="p-3 font-black text-red-500">{formatMoney(s.debt)}</td>}<td className="p-3 text-xs text-slate-500">{s.createdBy}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </Card>
                </div>
              )}

              {/* Purchases */}
              {activeTab==="purchases" && (
                <div className="space-y-4 animate-in fade-in">
                  <Card>
                    <SectionTitle icon="cart" title="تسجيل مشتريات/استلام" />
                    {err.purchase && <Notice variant="warn">{err.purchase}</Notice>}
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                      <Field label="التاريخ"><Input type="date" value={purchaseForm.date} onChange={e=>setPurchaseForm(f=>({...f,date:e.target.value}))}/></Field>
                      <Field label="المورد"><Select value={purchaseForm.supplier} onChange={e=>setPurchaseForm(f=>({...f,supplier:e.target.value}))}>{safeSuppliers.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}</Select></Field>
                      <Field label="المنتج"><Select value={purchaseForm.product} onChange={e=>setPurchaseForm(f=>({...f,product:e.target.value}))}>{safeProducts.map(p=><option key={p.id} value={p.name}>{p.name}</option>)}</Select></Field>
                      <Field label="الكمية"><Input type="number" value={purchaseForm.quantity} onChange={e=>setPurchaseForm(f=>({...f,quantity:e.target.value}))} /></Field>
                      <Field label="سعر الشراء"><Input type="number" step="0.01" value={purchaseForm.buyPrice} onChange={e=>setPurchaseForm(f=>({...f,buyPrice:e.target.value}))} /></Field>
                      <Field label="المدفوع كاش"><Input type="number" step="0.01" value={purchaseForm.paid} onChange={e=>setPurchaseForm(f=>({...f,paid:e.target.value}))} /></Field>
                      <Field label="نافوق/هالك"><Input type="number" value={purchaseForm.loss} onChange={e=>setPurchaseForm(f=>({...f,loss:e.target.value}))} placeholder="0"/></Field>
                      <Field label="ملاحظات"><Input value={purchaseForm.notes} onChange={e=>setPurchaseForm(f=>({...f,notes:e.target.value}))} /></Field>
                      <div className="col-span-2 lg:col-span-4 mt-2"><Button onClick={addPurchase} className="w-full sm:w-auto"><Icon name="plus"/> حفظ الاستلامة</Button></div>
                    </div>
                  </Card>
                  
                  <Card>
                    <SectionTitle icon="package" title={`سجل المشتريات (${filterDate})`} />
                    <div className="hidden sm:block table-wrap overflow-auto">
                      <table className="min-w-[1050px] w-full text-right"><thead className="bg-slate-50 text-slate-500 text-sm"><tr><th className="p-3">حذف</th><th className="p-3">التاريخ</th><th className="p-3">المورد</th><th className="p-3">الصنف</th><th className="p-3">الكمية</th><th className="p-3">السعر</th><th className="p-3">هالك</th><th className="p-3">الإجمالي</th>{isAdmin && <th className="p-3">مدفوع</th>}{isAdmin && <th className="p-3">باقي</th>}<th className="p-3">سجّل</th></tr></thead>
                        <tbody>
                          {safePurchases.filter(p=>!filterDate || p.date===filterDate).map(p => (
                            <tr key={p.id} className="border-t border-slate-100 hover:bg-slate-50">
                              <td className="p-3">{canDeleteRow(p) ? (<SmallBtn onClick={()=>removeRow("purchase", p.id)} className="text-red-500"><Icon name="trash" size={18}/></SmallBtn>) : <span className="text-slate-300">—</span>}</td>
                              <td className="p-3 text-sm font-bold">{p.date}</td><td className="p-3 font-black">{p.supplier}</td><td className="p-3">{p.product}</td>
                              <td className="p-3 font-black">{formatQty(p.quantity)}</td><td className="p-3">{formatMoney(p.buyPrice)}</td><td className="p-3 text-red-500 font-bold">{formatQty(p.loss)}</td>
                              <td className="p-3 font-black">{formatMoney(p.total)}</td>{isAdmin && <td className="p-3 text-emerald-600">{formatMoney(p.paid)}</td>}
                              {isAdmin && <td className="p-3 text-red-500">{formatMoney(p.debt)}</td>}<td className="p-3 text-xs text-slate-500">{p.createdBy}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </Card>
                </div>
              )}

              {/* Expenses */}
              {activeTab==="expenses" && (
                <div className="space-y-4 animate-in fade-in">
                  <Card>
                    <SectionTitle icon="wallet" title="تسجيل مصروف" />
                    {err.expense && <Notice variant="warn">{err.expense}</Notice>}
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                      <Field label="التاريخ"><Input type="date" value={expenseForm.date} onChange={e=>setExpenseForm(f=>({...f,date:e.target.value}))}/></Field>
                      <Field label="نوع المصروف"><Input value={expenseForm.category} onChange={e=>setExpenseForm(f=>({...f,category:e.target.value}))} placeholder="بنزين، كارتة..." /></Field>
                      <Field label="المبلغ"><Input type="number" step="0.01" value={expenseForm.amount} onChange={e=>setExpenseForm(f=>({...f,amount:e.target.value}))}/></Field>
                      <Field label="الموزع (للتسوية)">
                        <Select value={expenseForm.driver} onChange={e=>setExpenseForm(f=>({...f,driver:e.target.value}))}>
                          <option value="">- مصروف عام -</option>{safeDrivers.map(d=><option key={d.id} value={d.name}>{d.name}</option>)}
                        </Select>
                      </Field>
                      <Field label="ملاحظات" className="col-span-2 lg:col-span-3"><Input value={expenseForm.notes} onChange={e=>setExpenseForm(f=>({...f,notes:e.target.value}))}/></Field>
                      <div className="col-span-2 lg:col-span-1 flex items-end"><Button variant="danger" onClick={addExpense} className="w-full"><Icon name="plus"/> خصم</Button></div>
                    </div>
                  </Card>
                  
                  <Card>
                    <SectionTitle icon="receipt" title={`سجل المصروفات (${filterDate})`} />
                    <div className="hidden sm:block table-wrap overflow-auto">
                      <table className="min-w-[900px] w-full text-right"><thead className="bg-slate-50 text-slate-500 text-sm"><tr><th className="p-3">حذف</th><th className="p-3">التاريخ</th><th className="p-3">النوع</th><th className="p-3">الموزع</th><th className="p-3">المبلغ</th><th className="p-3">ملاحظات</th><th className="p-3">سجّل</th></tr></thead>
                        <tbody>
                          {safeExpenses.filter(e=>!filterDate || e.date===filterDate).map(e => (
                            <tr key={e.id} className="border-t border-slate-100 hover:bg-slate-50">
                              <td className="p-3">{canDeleteRow(e) ? (<SmallBtn onClick={()=>removeRow("expense", e.id)} className="text-red-500"><Icon name="trash" size={18}/></SmallBtn>) : <span className="text-slate-300">—</span>}</td>
                              <td className="p-3 font-bold">{e.date}</td><td className="p-3 font-black text-slate-800">{e.category}</td><td className="p-3 text-slate-600">{e.driver||"-"}</td>
                              <td className="p-3 font-black text-red-600">{formatMoney(e.amount)}</td><td className="p-3 text-sm">{e.notes}</td><td className="p-3 text-xs text-slate-500">{e.createdBy}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </Card>
                </div>
              )}

              {/* Settlements */}
              {activeTab==="settlements" && isAdmin && (
                <Card className="animate-in fade-in">
                  <SectionTitle icon="users" title={`تقفيل اليومية للموزعين (${filterDate})`} desc="المحصل كاش ناقص المصروفات لبيان المطلوب توريده للخزينة." />
                  <div className="grid gap-4 mt-4">
                    {settlements.map(d => (
                      <div key={d.name} className="border border-slate-200 rounded-2xl overflow-hidden shadow-sm">
                        <div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                          <div><div className="font-black text-lg">{d.name}</div><div className="text-xs text-slate-500 mt-1">{d.count} عمليات بيع</div></div>
                          <div className="text-left"><div className="text-xs text-slate-500 font-black mb-1">المطلوب توريده</div><div className={`text-2xl font-black ${d.net >= 0 ? 'text-teal-700' : 'text-red-600'}`}>{formatMoney(d.net)} ج</div></div>
                        </div>
                        <div className="grid grid-cols-2 sm:grid-cols-4 p-4 gap-4 bg-white text-sm">
                          <div><div className="text-slate-400 text-xs font-black mb-1">إجمالي الفواتير</div><div className="font-black">{formatMoney(d.total)}</div></div>
                          <div><div className="text-emerald-600/70 text-xs font-black mb-1">كاش محصل</div><div className="font-black text-emerald-700">{formatMoney(d.cash)}</div></div>
                          <div><div className="text-red-500/70 text-xs font-black mb-1">مصروفات الموزع</div><div className="font-black text-red-600">{formatMoney(d.expenses)}</div></div>
                          <div><div className="text-amber-600/70 text-xs font-black mb-1">ديون آجلة (سوق)</div><div className="font-black text-amber-700">{formatMoney(d.debt)}</div></div>
                        </div>
                      </div>
                    ))}
                  </div>
                </Card>
              )}

              {/* Products, Customers, Suppliers, Drivers */}
              {["products","customers","suppliers","drivers"].includes(activeTab) && isAdmin && (
                <Card className="animate-in fade-in">
                  <SectionTitle icon={activeTab==="products"?"package":activeTab==="customers"?"user":activeTab==="suppliers"?"briefcase":"car"} title={`إدارة ${activeTab==="products"?"المنتجات":activeTab==="customers"?"العملاء":activeTab==="suppliers"?"الموردين":"الموزعين"}`} />
                  
                  {activeTab==="products" ? (
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                      <Field label="القسم"><Input value={productForm.category} onChange={e=>setProductForm(f=>({...f,category:e.target.value}))} placeholder="كتاكيت، أعلاف" /></Field>
                      <Field label="الاسم"><Input value={productForm.name} onChange={e=>setProductForm(f=>({...f,name:e.target.value}))} placeholder="اسم الصنف" /></Field>
                      <Field label="الوحدة"><Input value={productForm.unit} onChange={e=>setProductForm(f=>({...f,unit:e.target.value}))} placeholder="كتكوت، طن" /></Field>
                      <div className="flex items-end"><Button onClick={addProduct} className="w-full">إضافة</Button></div>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                      <Field label="الاسم"><Input value={personForm.name} onChange={e=>setPersonForm(f=>({...f, name:e.target.value}))} /></Field>
                      <Field label="تليفون"><Input value={personForm.phone} onChange={e=>setPersonForm(f=>({...f, phone:e.target.value}))} /></Field>
                      <div className="flex items-end"><Button onClick={()=>addPerson(activeTab==="customers"?"customer":activeTab==="suppliers"?"supplier":"driver")} className="w-full">إضافة</Button></div>
                    </div>
                  )}

                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-6">
                    {(activeTab==="products"?safeProducts:activeTab==="customers"?safeCustomers:activeTab==="suppliers"?safeSuppliers:safeDrivers).map(p => (
                      <div key={p.id} className="border border-slate-100 rounded-xl p-4 bg-slate-50 flex justify-between items-center">
                        <div>
                          {activeTab==="products" && <div className="text-xs text-teal-700 font-black mb-1">{p.category}</div>}
                          <div className="font-black text-lg text-slate-800">{p.name}</div>
                          {activeTab==="products" ? (
                            <div className="text-sm font-bold text-slate-500 mt-2">المخزون: <span className="text-slate-900 font-black">{formatQty(stockByProduct[p.name])}</span> {p.unit}</div>
                          ) : ( <div className="text-xs text-slate-500 mt-1">{p.phone||"بدون رقم"}</div> )}
                        </div>
                        <button onClick={()=>removeRow(activeTab==="products"?"product":activeTab==="customers"?"customer":activeTab==="suppliers"?"supplier":"driver", p.id)} className="text-red-400 p-2 hover:bg-red-50 rounded-lg"><Icon name="trash"/></button>
                      </div>
                    ))}
                  </div>
                </Card>
              )}

              {/* Receipts & Settings */}
              {activeTab === "receipts" && (
                <Card className="animate-in fade-in">
                  <SectionTitle icon="printer" title="إصدار وطباعة إيصالات العملاء" />
                  <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                    <Field label="التاريخ"><Input type="date" value={receiptDate} onChange={(e)=>setReceiptDate(e.target.value)} /></Field>
                    <Field label="العميل"><Select value={receiptCustomer} onChange={(e)=>setReceiptCustomer(e.target.value)}><option value="">اختر عميل</option>{safeCustomers.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}</Select></Field>
                    <Field label="الموزع"><Select value={receiptDriver} onChange={(e)=>setReceiptDriver(e.target.value)}><option value="">الكل</option>{safeDrivers.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}</Select></Field>
                    <div className="col-span-2 sm:col-span-1 flex items-end"><Button onClick={buildReceipt} className="w-full">بحث وتجميع</Button></div>
                  </div>
                  {receiptPreview && (
                    <div className="mt-6 border-t border-slate-200 pt-6 text-center">
                      <h3 className="text-xl font-black mb-4">فاتورة: {receiptPreview.customer}</h3>
                      <Button variant="success" onClick={printReceipt} className="px-8 py-4"><Icon name="printer" size={24}/> طباعة</Button>
                    </div>
                  )}
                </Card>
              )}

              {activeTab === "settings" && (
                <Card className="animate-in fade-in">
                  <SectionTitle icon="settings" title="إعدادات النظام" />
                  <div className="mb-6">
                    <h4 className="font-black text-slate-800 mb-3 border-b pb-2">بيانات الشركة (تظهر في الإيصالات)</h4>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                      <Field label="الاسم"><Input value={company.name} onChange={e=>setCompany(c=>({...c, name:e.target.value}))}/></Field>
                      <Field label="اختصار"><Input value={company.short} onChange={e=>setCompany(c=>({...c, short:e.target.value}))}/></Field>
                      <Field label="تليفون"><Input value={company.phone} onChange={e=>setCompany(c=>({...c, phone:e.target.value}))}/></Field>
                      <Field label="عنوان"><Input value={company.address} onChange={e=>setCompany(c=>({...c, address:e.target.value}))}/></Field>
                    </div>
                  </div>
                  <div className="mb-6">
                    <h4 className="font-black text-slate-800 mb-3 border-b pb-2">تغيير كلمة المرور الخاصة بك</h4>
                    {myPinMsg && <Notice variant={myPinMsg.includes("✅") ? "info" : "warn"}>{myPinMsg}</Notice>}
                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                      <Field label="الرقم الحالي"><Input value={myPin.current} onChange={e=>setMyPin(p=>({...p,current:e.target.value}))} type="password" inputMode="numeric" /></Field>
                      <Field label="الرقم الجديد"><Input value={myPin.newPin} onChange={e=>setMyPin(p=>({...p,newPin:e.target.value}))} type="password" inputMode="numeric" /></Field>
                      <div className="flex items-end"><Button onClick={changeMyPin} className="w-full">تحديث السيرفر</Button></div>
                    </div>
                  </div>
                  {isAdmin && (
                    <div className="mt-4 border-t pt-4">
                      <Button variant="danger" onClick={resetAllData} className="w-full sm:w-auto">حذف قاعدة البيانات السحابية بالكامل (Reset)</Button>
                    </div>
                  )}
                </Card>
              )}
            </main>
          </div>
          
          <div className="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center z-40 pb-safe px-1 pt-1 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
            <button onClick={()=>navigate(isAdmin?"dashboard":"sales")} className={`flex flex-col items-center flex-1 py-2 ${activeTab===(isAdmin?"dashboard":"sales")?'text-teal-700':'text-slate-400'}`}><Icon name="home" size={24}/><span className="text-[10px] font-black mt-1">{isAdmin?"الرئيسية":"مبيعات"}</span></button>
            <button onClick={()=>navigate("sales")} className={`flex flex-col items-center flex-1 py-2 ${activeTab==="sales"?'text-teal-700':'text-slate-400'}`}><Icon name="truck" size={24}/><span className="text-[10px] font-black mt-1">مبيعات</span></button>
            <button onClick={()=>navigate("purchases")} className={`flex flex-col items-center flex-1 py-2 ${activeTab==="purchases"?'text-teal-700':'text-slate-400'}`}><Icon name="cart" size={24}/><span className="text-[10px] font-black mt-1">مشتريات</span></button>
            <button onClick={()=>setMenuOpen(true)} className={`flex flex-col items-center flex-1 py-2 ${menuOpen?'text-teal-700':'text-slate-400'}`}><Icon name="menu" size={24}/><span className="text-[10px] font-black mt-1">القائمة</span></button>
          </div>
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
